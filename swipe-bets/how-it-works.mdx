---
title: "How it works"
description: "Technical flow and internal behavior of Swipe Bets"
---

## Data flow

### 1. Initialization

When a user opens Swipe Bets:

1. Socket connection is established via `Socket.initSocket()`
2. API request fetches initial recommendations from `/recommendations/swipe-bets`
3. First 3 cards are loaded and displayed
4. WebSocket subscriptions are created for tournaments, events, and markets

### 2. Card enrichment

Raw recommendation data is enriched with real-time data:

```typescript
interface ISwipeBetItem {
  disciplineId: string;
  eventDate: string;
  eventId: string;
  eventMarketId: string;
  eventMarketName: string;
  eventName: string;
  eventSlug: string;
  eventTopIndex: number;
  outcomeId: string;
  outcomeName: string;
  price: number;
  sortIndex: number;
  tier: number;
  tournamentId: string;
  _id: string;
}

interface IEnrichedSwipeBetCard extends ISwipeBetItem {
  tournament: any; // Tournament entity from WebSocket
  event: any; // Event entity from WebSocket
  market: any; // Market entity from WebSocket
}
```

The enrichment process:

- Constructs entity IDs: `1.{disciplineId}.{tournamentId}`, `1.{eventId}`, `1.{eventId}.{eventMarketId}`
- Subscribes to WebSocket entities
- Fetches entity data via `getFromWebSocket()`
- Matches entities to cards based on ID relationships
- Filters out cards with missing or mismatched data

### 3. Card navigation

The system maintains 3 visible cards at a time:

- **Current card** (index 0): User can interact with this card
- **Next card** (index 1): Partially visible behind current card
- **Third card** (index 2): Slightly visible behind next card

When a card is swiped:

1. Current card animates off screen
2. Next cards move forward (index decrements)
3. New card loads from the queue
4. WebSocket subscriptions update to match new visible cards

### 4. Bet placement

When user swipes right:

1. Card animates to the right
2. Bet state changes to `'progress'`
3. Bet is initialized: `mobx.betslip.initNewBet()`
4. Bet data is prepared with amount and coefficient
5. API call to `/place` endpoint
6. Response is processed:
   - Status 0: Pending, retry after delay
   - Status 2: Coefficient changed, show alert
   - Error: Show error state
   - Success: Show success state
7. Balance is updated
8. Next card loads

### 5. Subscription management

WebSocket subscriptions are optimized:

**On card change:**

- Unsubscribe from entities no longer visible
- Subscribe to new entities
- Reuse existing subscriptions when possible

**Entity types:**

- `tournament`: Tournament data (name, logo)
- `event`: Event data (competitors, start time)
- `market`: Market data (outcomes, odds, frozen status)

### 6. Pagination

Cards are loaded in batches:

- Initial load: 100 cards (pageSize: 100)
- When 3 or fewer cards remain, next page loads automatically
- Excluded IDs are sent to avoid showing previously swiped cards
- Empty pages trigger automatic next page load

### 7. State persistence

User preferences are stored in localStorage:

- `swipeBetsPreset`: Custom bet amount
- `swipeBetsTutorialVisited`: Tutorial completion flag
- `swipeBetsExcludedIds`: Array of swiped card IDs

## Component hierarchy

```
SwipeBetsPage
└── ContainerSwipeBet
    ├── HeaderWrapperSwipeBet
    │   ├── Balance display
    │   ├── My Bets link
    │   └── Warning banner (if low balance)
    ├── WrapperSwipeBet (if tutorial completed)
    │   ├── CardsSwipeBet
    │   │   └── CardSwipeBet (3 instances)
    │   │       ├── Tournament info
    │   │       ├── Event matchup
    │   │       ├── Outcome details
    │   │       └── Possible win amount
    │   └── ControlsSwipeBet
    │       ├── Return button
    │       ├── Skip button
    │       ├── Bet button
    │       └── (Share button - commented out)
    └── BodySwipeBetTutorial (if tutorial not completed)
        ├── WrapperSwipeBetTutorial
        │   ├── HeaderSwipeBetTutorial
        │   ├── GuideSwipeBet
        │   ├── InputSwipeBetTutorial
        │   └── OddsInfoSwipeBet
        ├── ButtonRulesApply
        └── KeyboardSwipeBet (when input focused)
```

## Animation system

Cards use Framer Motion for animations:

**Card positioning:**

- Z-index: `3 - index` (current card on top)
- Scale: `1 - (index * 0.03)` (cards get smaller)
- TranslateY: `index * 2.75%` (cards stack vertically)

**Swipe animations:**

- Drag threshold: 150px
- Right swipe (bet): Animates to +300px, processes bet
- Left swipe (skip): Animates to -300px, loads next card
- Return: Animates from -300px back to 0

**State animations:**

- Progress: Overlay with spinner
- Success: Green overlay with checkmark
- Error: Red overlay, card returns to position

## Error handling

**Validation errors:**

- Invalid amount: Returns error before API call
- Insufficient balance: Disables bet button
- Frozen market: Shows lock icon, disables betting

**API errors:**

- Network error: Shows error overlay, card returns
- Bet rejection: Shows error message, card returns
- Timeout: Retries up to 5 times with delay

**Recovery:**

- Error state clears after 1 second
- Card returns to original position
- User can retry or skip the card

## Public API (MobX store)

The SwipeBets store exposes the following public actions for UI components and other stores.

### initSocketConnection()

Establishes WebSocket connection for real-time data updates.

**Arguments:** None

**Side effects:**
- Initializes Socket connection via `Socket.initSocket()`
- Logs error to console if connection fails

**Constraints:**
- Safe to call multiple times (Socket handles duplicate initialization)
- Does not throw errors, only logs them

### getSwipeBetsData({ disciplinesIds?, excludeIds?, pageSize? })

Fetches initial batch of betting recommendations and subscribes to their entities.

**Arguments:**
- `disciplinesIds` (string[]): Filter recommendations by discipline IDs. Empty array = all disciplines. Default: `[]`
- `excludeIds` (string[]): Exclude specific recommendation IDs. Default: uses `this.excludeIds` from localStorage
- `pageSize` (number): Number of recommendations per page. Default: `100`

**Side effects:**
- Calls `initSocketConnection()` to ensure WebSocket is ready
- Fetches recommendations from `/recommendations/swipe-bets` API
- Unsubscribes from all previous WebSocket entities
- Subscribes to tournament, event, and market entities for first 3 cards
- Updates `swipeBetsData`, `visibleCards`, and enrichment data
- If page is empty but more pages exist, automatically fetches next page (recursive)
- Stores request params in `lastRequestParams` for pagination

**Constraints:**
- Only one initial load can run at a time (guarded by `isLoadingInitialCards`)
- Returns early if already loading
- Automatically skips empty pages until data is found or max pages reached

### loadMoreSwipeBets({ disciplinesIds?, excludeIds?, pageNumber?, pageSize? })

Loads additional recommendations for pagination.

**Arguments:**
- `disciplinesIds` (string[]): Filter by discipline IDs. Default: `[]`
- `excludeIds` (string[]): Exclude specific IDs. Default: uses `this.excludeIds`
- `pageNumber` (number): Page to fetch. Default: `1`
- `pageSize` (number): Items per page. Default: `100`

**Side effects:**
- Fetches next page from `/recommendations/swipe-bets`
- Replaces `swipeBetsData.data` with new page data (does not append)
- Updates `swipeBetsData.meta` with new pagination info

**Constraints:**
- Only one pagination request at a time (guarded by `isLoadingMoreCards`)
- Requires `swipeBetsData` to exist (returns early if null)
- Does nothing if response is empty or fails

### updateVisibleCards()

Advances to next set of cards and manages WebSocket subscriptions.

**Arguments:** None

**Side effects:**
- Increments `currentCardIndex` (unless returning a card)
- Extracts next 3 cards from `swipeBetsData`
- Unsubscribes from entities no longer visible
- Subscribes to entities for new visible cards
- Updates `visibleCards`, `swipeBetsTournaments`, `swipeBetsEvents`, `swipeBetsMarkets`
- If ≤3 cards remain, automatically calls `loadMoreSwipeBets()` for next page
- Clears all data if no visible cards remain

**Constraints:**
- Subscription changes are optimized (only subscribe/unsubscribe deltas)
- Reuses existing subscriptions when cards share entities
- Auto-pagination triggers when running low on cards

### handleSwipeBet(marketId, outcomeId)

Places a bet on the current card and processes the result.

**Arguments:**
- `marketId` (string): Market identifier for the bet
- `outcomeId` (string): Outcome identifier to bet on

**Side effects:**
- Sets `isWaitingSwipeBet = true` and `hasSwipeBetError = false`
- Calls `makeSwipeBet()` to create and place bet
- Tracks analytics: `BEGIN_CHECKOUT`, `ADD_BET`, `PLACE_BET` or `REFUND`
- Processes bet response with retry logic (up to 5 attempts)
- Updates user balance via `mobx.profile.updateBalance()`
- Sets `swipeBetData` during processing, clears it when done
- Updates `hasSwipeBetError` based on result

**Returns:**
- `{ delay: number, hasError: boolean, status: number }`

**Constraints:**
- Only one bet can be processed at a time (returns error if `swipeBetData` exists)
- Validates bet amount before API call
- Retries pending bets (status 0) up to 5 times with delay
- Sends postMessage events for partner integration
- Handles coefficient changes (status 2) with alert

### returnLastRemovedCard()

Restores the last skipped card to the top of the stack.

**Arguments:** None

**Side effects:**
- Decrements `currentCardIndex` if > 0
- Fetches WebSocket data for returned card's entities
- Prepends card to `visibleCards` (max 3 cards)
- Updates `swipeBetsTournaments`, `swipeBetsEvents`, `swipeBetsMarkets`
- Adds entity IDs to subscription lists
- Sets `isCardReturned = true`
- Clears `lastRemovedCard`

**Constraints:**
- Only works if `lastRemovedCard` exists
- Returns early if no card to restore
- Removes 4th card if stack exceeds 3 cards

### getCurrentMaxBet()

Calculates maximum allowed bet amount for current card.

**Arguments:** None

**Side effects:**
- Initializes bet via `mobx.betslip.initNewBet()`
- Calls `/max-bet` API with outcome ID and currency
- Updates `swipeBetsMaxBet` with result
- Sets `swipeBetsMaxBet = null` if no current card

**Constraints:**
- Requires `enrichedCards[0]` to exist
- Uses current user's currency from profile

### getSwipeBetPossibleWin(amount, odd)

Calculates potential winnings for a bet.

**Arguments:**
- `amount` (number): Bet amount
- `odd` (number): Outcome odds/coefficient

**Side effects:**
- None (pure calculation)

**Returns:**
- Rounded currency value of `amount * odd`
- Uses `swipeBetsMaxBet` if `swipeBetCurrentTab === 'max'`
- Uses provided `amount` if `swipeBetCurrentTab === 'custom'`

**Constraints:**
- Returns 0 if calculation fails
- Respects currency precision via `roundCurrency()`

### setSwipeBetsPreset(value)

Sets custom bet amount for swipe bets.

**Arguments:**
- `value` (string): Bet amount as string

**Side effects:**
- Updates `swipeBetsPreset` in memory
- Does NOT persist to localStorage (UI must call `LS.set()` separately)

**Constraints:**
- Accepts any string value (validation happens elsewhere)

### getSwipeBetsPreset()

Retrieves current custom bet amount.

**Arguments:** None

**Returns:**
- Current `swipeBetsPreset` value (string | null)

**Side effects:** None

### setSwipeBetsTutorialVisited(value)

Marks tutorial as completed or not completed.

**Arguments:**
- `value` (boolean): Tutorial completion status

**Side effects:**
- Updates `swipeBetsTutorialVisited` in memory
- Persists to localStorage via `LS.set('swipeBetsTutorialVisited', value)`

**Constraints:**
- Persists immediately to localStorage

### getSwipeBetsTutorialVisited()

Checks if user has completed the tutorial.

**Arguments:** None

**Returns:**
- Current `swipeBetsTutorialVisited` value (boolean)

**Side effects:** None

### addExcludedId(id)

Adds a recommendation ID to the exclusion list.

**Arguments:**
- `id` (string): Recommendation ID to exclude

**Side effects:**
- Appends `id` to `excludeIds` array (if not already present)
- Persists updated array to localStorage via `LS.set('swipeBetsExcludedIds')`

**Constraints:**
- Ignores empty/falsy IDs
- Prevents duplicates
- Silently catches localStorage errors

### Computed properties

#### enrichedCards

Returns visible cards enriched with WebSocket data.

**Returns:**
- Array of `IEnrichedSwipeBetCard` with tournament, event, and market data
- Filters out cards with missing or mismatched entity relationships
- Validates event belongs to tournament and market belongs to event

**Side effects:** None (computed)

**Constraints:**
- Only returns cards where all entities exist and relationships are valid
- Cards with missing data are silently filtered out

#### isMarketInLine

Checks if current card's market is still available for betting.

**Returns:**
- `true` if market exists in `mobx.store.markets`
- `false` otherwise

**Side effects:** None (computed)

**Constraints:**
- Requires `enrichedCards[0]` to exist
- Returns `undefined` if no current card